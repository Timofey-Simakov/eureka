# Лабораторная работа №1
## Исследование и описание бизнес-процессов предприятия

---

## Цель работы
Создание объектно-ориентированной модели автоматизированной ИС управления личной базой знаний.

**Объект:** Система управления знаниями (Personal Knowledge Management System)
**Предмет:** АИС Eureka - персональная база знаний с wiki-интерфейсом и графовой визуализацией

---

## Организационная структура системы

```
Eureka Knowledge Base System
├── Пользовательский уровень
│   ├── Читатели (просмотр страниц)
│   ├── Редакторы (создание и редактирование)
│   └── Администраторы (управление системой)
│
├── Уровень данных
│   ├── Управление страницами
│   ├── Управление связями
│   ├── Управление пользователями
│   └── Управление изображениями
│
├── Уровень визуализации
│   ├── Текстовый редактор (Markdown)
│   ├── Граф знаний (D3.js)
│   └── Поиск и навигация
│
└── Административный уровень
    ├── Управление пользователями
    ├── Управление страницами
    └── Мониторинг системы
```

---

## Документооборот системы

### Основные сущности данных

1. **Журнал страниц**
   - ID страницы
   - Название страницы
   - Автор (пользователь)
   - Дата создания
   - Дата последнего изменения
   - Содержимое (Markdown)

2. **Справочник пользователей**
   - ID пользователя
   - Email
   - Хеш пароля
   - Роль (user/admin)
   - Дата отзыва JWT токена

3. **Реестр связей между страницами**
   - ID связи
   - ID страницы-источника
   - ID страницы-назначения
   - Тег связи (опционально)

4. **Справочник изображений**
   - ID изображения
   - ID страницы
   - Имя файла
   - MIME-тип
   - Размер в байтах
   - Бинарное содержимое
   - Дата загрузки

5. **История изменений страниц**
   - ID страницы
   - Дата изменения
   - Автор изменения
   - Предыдущая версия

6. **Граф знаний**
   - Узлы (страницы)
   - Рёбра (связи)
   - Метрики связности

---

## Ключевые бизнес-процессы

### 1. Управление знаниями

#### Создание страницы
1. Пользователь авторизуется в системе
2. Открывает режим "Редактирование"
3. Нажимает "Создать страницу"
4. Вводит название страницы
5. Создаётся новая страница с пустым содержимым
6. Система перенаправляет в редактор

#### Редактирование страницы
1. Пользователь выбирает страницу из списка
2. Открывает редактор
3. Вводит текст в формате Markdown
4. Система автоматически сохраняет через 2 секунды после последнего изменения
5. Отображается статус сохранения:
   - "Есть изменения" - несохранённые данные
   - "Сохранение..." - процесс сохранения
   - "Сохранено" - данные сохранены
6. Пользователь может использовать клавиатурные сокращения:
   - Ctrl+S - принудительное сохранение
   - Ctrl+B - жирный текст
   - Ctrl+I - курсив
   - Ctrl+K - вставка ссылки

#### Создание wiki-ссылок
1. Пользователь вводит текст в формате `[[Название страницы]]`
2. Система парсит Markdown и обнаруживает wiki-ссылки
3. Проверяет существование целевой страницы
4. Если страница существует:
   - Создаётся кликабельная ссылка (синяя)
   - В БД создаётся запись связи
5. Если страница не существует:
   - Создаётся красная ссылка
   - При клике предлагается создать страницу
6. Связи отображаются на графе

#### Просмотр графа знаний
1. Пользователь открывает главную страницу или страницу "Граф"
2. Система загружает все страницы и связи
3. D3.js строит force-directed граф:
   - Узлы = страницы
   - Рёбра = связи между страницами
   - Размер узла зависит от количества исходящих связей
4. Пользователь может:
   - Масштабировать (Scroll)
   - Перемещать (Drag)
   - Кликнуть на узел для перехода к странице
   - Перетаскивать узлы

### 2. Управление пользователями (Администратор)

#### Регистрация нового пользователя
1. Пользователь открывает страницу регистрации
2. Вводит email и пароль
3. Система проверяет уникальность email
4. Хеширует пароль с помощью bcrypt (cost 10)
5. Создаёт запись в таблице users
6. Автоматически выполняет вход
7. Генерирует JWT токен (срок действия 24 часа)
8. Перенаправляет на главную страницу

#### Авторизация пользователя
1. Пользователь открывает страницу входа
2. Вводит email и пароль
3. Система проверяет существование пользователя
4. Сравнивает хеш пароля
5. Генерирует JWT токен
6. Возвращает токен клиенту
7. Клиент сохраняет токен в localStorage
8. Перенаправляет на главную страницу

#### Управление пользователями (только admin)
1. Администратор открывает панель администратора
2. Видит список всех пользователей:
   - ID
   - Email
   - Роль
   - Дата отзыва токена
3. Может удалить пользователя:
   - Подтверждает удаление
   - Система удаляет пользователя
   - **CASCADE**: Все страницы пользователя удаляются автоматически

### 3. Поиск и навигация

#### Полнотекстовый поиск
1. Пользователь вводит запрос в поле поиска
2. Система применяет debounce (500мс)
3. Фильтрует страницы по названию
4. Отображает результаты в реальном времени
5. Пользователь кликает на результат
6. Открывается страница просмотра/редактирования

#### Навигация по режимам
1. **Домой** - список всех страниц + граф
2. **Граф** - полноэкранная графовая визуализация
3. **Чтение** - список страниц для чтения
4. **Редактирование** - список страниц для редактирования
5. **Админ** (только для администраторов) - панель управления

### 4. Работа с изображениями

#### Загрузка изображения
1. Пользователь в редакторе нажимает "Изображение"
2. Выбирает файл
3. Система проверяет тип файла (image/*)
4. Загружает файл на сервер
5. Сохраняет в БД:
   - Бинарное содержимое
   - Метаданные (имя, тип, размер)
   - Привязка к странице
6. Возвращает URL изображения
7. Вставляет Markdown: `![alt](url)`

### 5. Административные процессы

#### Управление страницами (admin)
1. Администратор открывает админ-панель
2. Переходит на вкладку "Страницы"
3. Видит список всех страниц системы:
   - ID страницы
   - Название
   - Автор (email)
   - Дата изменения
4. Может удалить любую страницу:
   - Подтверждает удаление
   - Система удаляет страницу
   - **CASCADE**: Все связи и изображения удаляются автоматически

---

## Технологическая структура КИС

**Уровень:** Веб-приложение
**Архитектура:** Клиент-серверная (REST API)
**Развёртывание:** Docker Compose (контейнеризация)

### Технологический стек

#### Frontend (Client)
- **Framework:** React 19.1
- **Language:** TypeScript 5.7
- **Build tool:** Vite 7.1
- **Routing:** React Router 7
- **Visualization:** D3.js (force-directed graph)
- **Markdown:** marked.js + DOMPurify
- **HTTP Client:** Axios
- **Server:** Nginx 1.27

#### Backend (Server)
- **Language:** Go 1.22
- **Router:** Chi
- **Database:** PostgreSQL 16
- **SQL Generator:** sqlc (type-safe queries)
- **Auth:** golang-jwt (JWT tokens)
- **Hashing:** bcrypt
- **UUID:** google/uuid

#### Infrastructure
- **Containerization:** Docker + Docker Compose
- **Orchestration:** Makefile
- **Database Migration:** migrate

---

## Техническое задание

### Функциональные требования

#### 1. Модуль аутентификации

**Регистрация пользователя:**
- Email (уникальный)
- Пароль (минимум 6 символов)
- Автоматическое присвоение роли "user"
- Хеширование пароля (bcrypt, cost 10)

**Авторизация:**
- Проверка email и пароля
- Генерация JWT токена (срок 24 часа)
- Включение в токен: user_id, role, exp, iat

**Операции:**
- [x] Регистрация нового пользователя
- [x] Вход в систему
- [x] Выход из системы (удаление токена на клиенте)
- [x] Автоматический редирект при 401 Unauthorized

#### 2. Модуль управления страницами

**Данные страницы:**
- ID (UUID)
- Название
- Содержимое (Markdown)
- ID автора
- Дата создания
- Дата изменения

**Операции:**
- [x] Создание страницы
- [x] Просмотр страницы
- [x] Редактирование страницы
- [x] Удаление страницы (только владелец или admin)
- [x] Список всех страниц пользователя
- [x] Автосохранение (debounce 2 сек)
- [x] Полнотекстовый поиск по названию

#### 3. Модуль связей между страницами

**Данные связи:**
- ID (UUID)
- ID страницы-источника
- ID страницы-назначения
- Тег (опционально)

**Операции:**
- [x] Автоматическое создание связи при использовании wiki-ссылок
- [x] Удаление связи при удалении страницы (CASCADE)
- [x] Получение всех связей для построения графа
- [x] Проверка существования целевой страницы

#### 4. Модуль визуализации графа знаний

**Компоненты графа:**
- Узлы (страницы)
- Рёбра (связи)
- Стрелки (направление связи)
- Метки (названия страниц)

**Возможности:**
- [x] Force-directed layout (физическая симуляция)
- [x] Динамический размер узла (зависит от числа исходящих связей)
  - Базовый радиус: 20px
  - +5px за каждую исходящую связь
  - Максимальный радиус: 40px
- [x] Масштабирование (zoom)
- [x] Перемещение (pan)
- [x] Перетаскивание узлов (drag)
- [x] Клик по узлу → переход к странице
- [x] Hover эффект на узлах

#### 5. Модуль Markdown-редактора

**Возможности редактора:**
- Панель инструментов:
  - [x] Заголовки (H1, H2, H3)
  - [x] Жирный текст (Ctrl+B)
  - [x] Курсив (Ctrl+I)
  - [x] Зачёркнутый
  - [x] Списки (маркированные, нумерованные)
  - [x] Ссылки (Ctrl+K)
  - [x] Изображения
  - [x] Код
  - [x] Цитаты
  - [x] Горизонтальная линия

**Wiki-ссылки:**
- [x] Синтаксис: `[[Название страницы]]`
- [x] Существующая страница → синяя ссылка
- [x] Несуществующая страница → красная ссылка
- [x] Клик по красной ссылке → создание страницы
- [x] Автоматическое создание связи в БД

**Внешние ссылки:**
- [x] Автоопределение домена (google.com → https://google.com)
- [x] Открытие в новой вкладке (target="_blank")
- [x] Защита от XSS (DOMPurify)

#### 6. Модуль администрирования (только admin)

**Управление пользователями:**
- [x] Просмотр списка всех пользователей
- [x] Удаление пользователя
- [x] CASCADE удаление всех страниц пользователя

**Управление страницами:**
- [x] Просмотр всех страниц в системе
- [x] Просмотр автора каждой страницы
- [x] Удаление любой страницы
- [x] CASCADE удаление связей и изображений

**Данные отображения:**
- ID пользователя/страницы
- Email пользователя
- Название страницы
- Дата последнего изменения
- Роль пользователя

#### 7. Модуль работы с изображениями

**Хранение:**
- Бинарные данные в PostgreSQL (BYTEA)
- Привязка к странице (foreign key)

**Данные изображения:**
- ID (UUID)
- ID страницы
- Имя файла
- MIME-тип
- Размер в байтах
- Бинарное содержимое
- Дата загрузки

**Операции:**
- [x] Загрузка изображения
- [x] Получение изображения
- [x] Удаление изображения (CASCADE при удалении страницы)
- [x] Проверка типа файла
- [x] Вставка в Markdown

---

## Нефункциональные требования

### Качество

**Надёжность:**
- Автоматическое восстановление после паники (Panic Recovery Middleware)
- Валидация данных на уровне БД (constraints, foreign keys)
- Транзакционность операций

**Безопасность:**
- JWT токены с подписью (HMAC SHA256)
- Хеширование паролей (bcrypt cost 10)
- Защита от XSS (DOMPurify sanitization)
- Защита от SQL-инъекций (sqlc parameterized queries)
- CORS политика
- Проверка авторизации для всех защищённых эндпоинтов

**Целостность данных:**
- Foreign key constraints
- CASCADE удаление зависимых данных
- Unique constraints (email, links)
- NOT NULL constraints

### Производительность

**Оптимизация клиента:**
- Debouncing поиска (500мс)
- Debouncing автосохранения (2сек)
- Memoization графа (useMemo)
- Lazy loading маршрутов
- Code splitting

**Оптимизация сервера:**
- Индексы БД (primary keys, foreign keys)
- Подготовленные запросы (sqlc)
- Connection pooling (database/sql)

**Время отклика:**
- API запросы: < 100ms (в среднем)
- Построение графа: < 500ms
- Загрузка страницы: < 200ms

### Масштабируемость

**Горизонтальное масштабирование:**
- Stateless API сервер (JWT в каждом запросе)
- Возможность запуска нескольких инстансов API
- Load balancing через Nginx

**Вертикальное масштабирование:**
- PostgreSQL оптимизирован для роста данных
- Индексы для быстрых запросов
- Эффективное использование памяти

### Совместимость

**Браузеры:**
- Chrome/Edge 90+
- Firefox 88+
- Safari 14+

**Платформы развёртывания:**
- Linux (основная)
- macOS (разработка)
- Windows (WSL для разработки)

**Зависимости:**
- Docker 20+
- Docker Compose 2+
- PostgreSQL 16

### Удобство использования (UX)

**Обратная связь:**
- Toast уведомления для всех операций
- Loading состояния (spinners)
- Empty states (подсказки при пустых списках)
- Статус сохранения в редакторе

**Навигация:**
- Breadcrumbs
- Горячие клавиши (Ctrl+S, Ctrl+B, Ctrl+I, Ctrl+K)
- Быстрый поиск с автодополнением

**Визуализация:**
- Цветовая индикация:
  - Синие ссылки = существующие страницы
  - Красные ссылки = несуществующие страницы
  - Зелёные уведомления = успех
  - Красные уведомления = ошибка

### Мониторинг и логирование

**Логи сервера:**
- Structured logging
- Request ID для трейсинга
- HTTP метод, путь, статус, длительность, размер ответа
- Timestamp для каждого запроса

**Health check:**
- Эндпоинт `/healthz` для проверки работоспособности
- Проверка подключения к БД

---

## Архитектурные решения

### Backend Architecture

**Layered Architecture:**
```
Request → Middleware Chain → Handler → Service → Database
```

**Middleware Chain:**
1. **Recovery** - перехват panic, предотвращение краша сервера
2. **RequestID** - добавление уникального ID к каждому запросу
3. **Logger** - логирование всех HTTP запросов
4. **CORS** - обработка cross-origin запросов
5. **Auth** - проверка JWT токена

**Error Handling:**
- Structured errors с кодами и сообщениями
- Предопределённые ошибки (ErrNotFound, ErrUnauthorized, etc.)
- Консистентный формат ответов об ошибках

### Frontend Architecture

**Component Hierarchy:**
```
App (Router)
├── Login
├── Register
├── Home (Pages List + Graph)
├── Reading (Pages List)
├── Editing (Pages List)
├── Editor (Markdown Editor)
├── Graph (Full-screen Graph)
├── View (Page Viewer)
└── Admin (Admin Panel)
```

**Design System:**
- Централизованная цветовая палитра
- Единообразные отступы (4px grid)
- Типографическая система
- Переиспользуемые UI компоненты

**State Management:**
- Local state (useState)
- Context для глобального состояния (не используется, токен в localStorage)
- Custom hooks для shared логики

### Database Schema

**Tables:**

1. **users**
   - id (UUID, PK)
   - email (TEXT, UNIQUE)
   - pass_hash (TEXT)
   - role (ENUM: user, adm)
   - jwt_revoked_at (TIMESTAMPTZ)

2. **pages**
   - id (UUID, PK)
   - user_id (UUID, FK → users)
   - name (TEXT)
   - body (TEXT)
   - created_at (TIMESTAMPTZ)
   - updated_at (TIMESTAMPTZ)

3. **page_links**
   - id (UUID, PK)
   - id_source (UUID, FK → pages)
   - id_dest (UUID, FK → pages)
   - tag (TEXT, nullable)
   - UNIQUE(id_source, id_dest)

4. **images**
   - id (UUID, PK)
   - page_id (UUID, FK → pages)
   - name (TEXT)
   - mime (TEXT)
   - size_bytes (INT)
   - content (BYTEA)
   - created_at (TIMESTAMPTZ)

**Relationships:**
- users 1:N pages (один пользователь - много страниц)
- pages 1:N images (одна страница - много изображений)
- pages N:M pages через page_links (многие-ко-многим связи)

**Constraints:**
- CASCADE DELETE: при удалении пользователя → удаляются его страницы
- CASCADE DELETE: при удалении страницы → удаляются её связи и изображения
- UNIQUE: email пользователя, пара (id_source, id_dest) в links

---

## API Спецификация

### Authentication Endpoints

**POST /api/auth/register**
```json
Request:
{
  "email": "user@example.com",
  "password": "password123"
}

Response: 200 OK
{
  "accessToken": "eyJhbGc..."
}

Errors:
400 - Email already exists
400 - Invalid email format
400 - Password too short
```

**POST /api/auth/login**
```json
Request:
{
  "email": "user@example.com",
  "password": "password123"
}

Response: 200 OK
{
  "accessToken": "eyJhbGc..."
}

Errors:
401 - Invalid credentials
```

### Pages Endpoints

**GET /api/pages**
```
Headers: Authorization: Bearer <token>

Response: 200 OK
[
  {
    "id": "uuid",
    "name": "Page Title",
    "owner_id": "uuid",
    "owner_email": "user@example.com",
    "updated_at": "2025-10-23T12:00:00Z"
  }
]

Errors:
401 - Unauthorized
```

**POST /api/pages**
```json
Headers: Authorization: Bearer <token>

Request:
{
  "name": "New Page"
}

Response: 201 Created
{
  "id": "uuid",
  "name": "New Page",
  "body": "",
  "user_id": "uuid",
  "created_at": "2025-10-23T12:00:00Z",
  "updated_at": "2025-10-23T12:00:00Z"
}

Errors:
400 - Name is required
401 - Unauthorized
```

**GET /api/pages/:id**
```
Headers: Authorization: Bearer <token>

Response: 200 OK
{
  "id": "uuid",
  "name": "Page Title",
  "body": "# Markdown content",
  "user_id": "uuid",
  "created_at": "2025-10-23T12:00:00Z",
  "updated_at": "2025-10-23T12:00:00Z"
}

Errors:
404 - Page not found
401 - Unauthorized
```

**PUT /api/pages/:id**
```json
Headers: Authorization: Bearer <token>

Request:
{
  "name": "Updated Title",
  "body": "# Updated content"
}

Response: 200 OK
{
  "id": "uuid",
  "name": "Updated Title",
  "body": "# Updated content",
  "user_id": "uuid",
  "created_at": "2025-10-23T12:00:00Z",
  "updated_at": "2025-10-23T12:30:00Z"
}

Errors:
404 - Page not found
401 - Unauthorized
403 - Not the owner
```

**DELETE /api/pages/:id**
```
Headers: Authorization: Bearer <token>

Response: 200 OK
{
  "ok": "1"
}

Errors:
404 - Page not found
401 - Unauthorized
403 - Not the owner (unless admin)
```

### Graph Endpoint

**GET /api/graph**
```
Headers: Authorization: Bearer <token>

Response: 200 OK
[
  {
    "node_id": "uuid",
    "node_name": "Page A",
    "edge_from": "uuid_a",
    "edge_to": "uuid_b",
    "tag": {
      "String": "related",
      "Valid": true
    }
  }
]

Errors:
401 - Unauthorized
```

### Admin Endpoints (requires role="adm")

**GET /api/admin/users**
```
Headers: Authorization: Bearer <token>

Response: 200 OK
[
  {
    "id": "uuid",
    "email": "user@example.com",
    "role": "user",
    "jwt_revoked_at": "1970-01-01T00:00:00Z"
  }
]

Errors:
401 - Unauthorized
403 - Not an admin
```

**DELETE /api/admin/users/:id**
```
Headers: Authorization: Bearer <token>

Response: 200 OK
{
  "ok": "1"
}

Errors:
400 - Invalid ID
401 - Unauthorized
403 - Not an admin
```

**GET /api/admin/pages**
```
Headers: Authorization: Bearer <token>

Response: 200 OK
[
  {
    "id": "uuid",
    "name": "Page Title",
    "owner_email": "user@example.com",
    "updated_at": "2025-10-23T12:00:00Z"
  }
]

Errors:
401 - Unauthorized
403 - Not an admin
```

**DELETE /api/admin/pages/:id**
```
Headers: Authorization: Bearer <token>

Response: 200 OK
{
  "ok": "1"
}

Errors:
400 - Invalid ID
401 - Unauthorized
403 - Not an admin
```

### Health Check

**GET /healthz**
```
Response: 200 OK
"ok"
```

---

## 📝 Структура отчёта

1. **Титульный лист**
2. **Содержание**
3. **Введение** - выбор системы управления знаниями
4. **Организационная структура**
5. **Документооборот** - перечень и описание сущностей данных
6. **Бизнес-процессы** - описание процессов управления знаниями
7. **Процессы автоматизации** - выбор и обоснование
8. **Технические требования** - полный стек технологий
9. **Техническое задание** - детальная спецификация модулей
10. **API Спецификация** - полное описание эндпоинтов
11. **Архитектурные решения** - описание архитектуры системы

---

## Чек-лист выполнения работы

### Этап 1: Анализ предметной области
- [x] Выбор системы для разработки ИС (Eureka - Personal Knowledge Base)
- [x] Описание организационной структуры
- [x] Перечисление документов документооборота (сущности данных)
- [x] Описание бизнес-процессов

### Этап 2: Проектирование системы
- [x] Определение процессов для автоматизации
- [x] Выделение функций будущей КИС (7 модулей)
- [x] Описание взаимосвязей между функциями

### Этап 3: Техническая спецификация
- [x] Определение требований к ПО
- [x] Определение требований к аппаратной части
- [x] Выбор топологии сети (клиент-серверная REST)
- [x] Выбор СУБД (PostgreSQL 16) и средств разработки

### Этап 4: Техническое задание
- [x] Формулировка функциональных требований
- [x] Формулировка нефункциональных требований
- [x] Описание справочников и документов
- [x] Определение операций с данными

### Этап 5: Документирование
- [x] Оформление отчёта
- [x] Проверка полноты описания
- [x] Финальное редактирование

---

## 🎓 Заключение

В рамках лабораторной работы была проведена комплексная работа по исследованию и описанию бизнес-процессов системы управления личными знаниями **Eureka**.

**Основные достижения:**

1. **Анализ предметной области**: Определена организационная структура системы управления знаниями, включающая 4 уровня: пользовательский, данных, визуализации и административный.

2. **Документооборот**: Выделено 6 основных сущностей данных (страницы, пользователи, связи, изображения, история, граф) с полным описанием атрибутов.

3. **Бизнес-процессы**: Описано 5 ключевых групп процессов:
   - Управление знаниями (создание, редактирование, связывание)
   - Управление пользователями (регистрация, авторизация, администрирование)
   - Поиск и навигация
   - Работа с изображениями
   - Административные процессы

4. **Техническое задание**: Разработано полное ТЗ с 7 функциональными модулями и детальными нефункциональными требованиями.

5. **Архитектурные решения**: Определена современная архитектура с использованием:
   - Клиент-серверной модели (REST API)
   - Контейнеризации (Docker)
   - Типобезопасности (TypeScript + sqlc)
   - Реактивного интерфейса (React 19.1)
   - Графовой визуализации (D3.js)

**Технологический стек** обеспечивает:
- Высокую производительность (Go backend)
- Безопасность (JWT, bcrypt, XSS protection)
- Масштабируемость (stateless API)
- Удобство разработки (hot reload, type safety)

**Результат**: Полностью функциональная система управления знаниями с веб-интерфейсом, готовая к промышленной эксплуатации и дальнейшему развитию.

---

*Документ создан в формате Markdown
Проект: Eureka Personal Knowledge Base
Дата: 24 октября 2025
Версия системы: 2.1.7*
